---
title: "Analysis"
author: "Susie and Teddie"
format: pdf
---

Packages: 

```{r}
library(tidyverse)
library(MASS)
library(VGAM)
```

Read in data: 
```{r}
data <- read_csv("ISSP_OECD2015.csv")

glimpse(data)
```

Clean data: 

```{r}
data_clean <- data%>%
  dplyr::select(-isco)%>%
  tidyr::drop_na()

data_clean$jobsec <- factor(data_clean$jobsec, 
                     ordered = TRUE, 
                     levels = c("Strongly disagree", "Disagree", "Neither nor", "Agree", "Strongly agree"))

data_clean$rmgt3 <- data_clean$relmgmt
data_clean$rmgt3[data_clean$relmgmt %in% c("Very bad", "Quite bad")] <- "Bad"
data_clean$rmgt3[data_clean$relmgmt %in% c("Very good", "Quite good")] <- "Good"
data_clean$rmgt3 <- factor(data_clean$rmgt3)

glimpse(data_clean)
```

Convert fulltime, sex, sector, union to binary variables for plots: 

```{r}

fulltime2 <- ifelse(data_clean$fulltime=="Part-time", 1, 0)
sex2 <- ifelse(data_clean$sex=="Male", 1, 0)
sector2 <- ifelse(data_clean$sector=="Public sector", 1, 0)
union2 <- ifelse(data_clean$union=="Union member", 1, 0)

```

Ordinal logistic regression model using VGLM.  3 models to investigate different fits.  mod0 does not have eprc. mod1 has eprc.  mod has eprc + rmgt3 + eprc:rmgt3.   

```{r}
mod0<- vglm(jobsec~ rmgt3 + unemp +ltu + sex2 + age + sector2 + fulltime2 + union2, data = data_clean, family = cumulative(ynames = TRUE, parallel = TRUE))

mod1<- vglm(jobsec~ eprc + rmgt3 + unemp +ltu + sex2 + age + sector2 + fulltime2 + union2, data = data_clean, family = cumulative(ynames = TRUE, parallel = TRUE))

mod<- vglm(jobsec~ eprc * rmgt3 + unemp +ltu + sex2 + age + sector2 + fulltime2 + union2, data = data_clean, family = cumulative(ynames = TRUE, parallel = TRUE))


summary(mod)

```

Compare models for significant contributors and best fit: 

```{r}
anova(mod0, mod1, mod, type = "I", test = "LRT")

AIC(mod0)
AIC(mod1)
AIC(mod)

```
The LRT test to compare the 3 models shows EPRC is a significant contributor to the model and eprc and rmgt3 have significant interaction, therefore we should explore the interaction and not interpret the main effects of eprc and rmgt3.  

AIC shows mod with eprc * rmgt3 is preferred fit. 

## Visuals to explore how eprc effects response different depending on level of rmgt3: 

Probability plot, showing probability of response given each eprc value: 1,2,...,6. This is based off data where the numeric variables are set at the median value for each, and the binary variables are set to the mean of the variables (meaning the proportion of the number of baseline outcomes over the total). The rgmt variable is collapsed into 3 categories at this point: bad, neither nor, good. There are three plots where the rest of the variables are all set in the way previously mentioned and the only variable that changes is the level of rgmt3 from bad to neither nor to good.  


Predictions across levels of eprc for rmgt3 set to Bad: 

```{r}
new <- data.frame(eprc = 0:6, rmgt3="Bad", unemp = median(data_clean$unemp), 
                  ltu = median(data_clean$ltu), 
                  sex2 = mean(sex2),
                  age = median(data_clean$age), 
                  sector2 = mean(sector2), 
                  fulltime2 =  mean(fulltime2),
                  union2 = mean(union2))
predict(mod, type = "response", newdata = new) %>% matplot(type="b")

predict_bad <- predict(mod, type = "response", newdata = new)

## nicer graph in ggplot
pred_bad <- cbind(new, predict_bad)

long_pred_bad <- pred_bad %>%
     pivot_longer(cols = colnames(predict_bad),
    names_to = "jobsec",
    values_to = "prob")%>%
  mutate(jobsec = factor(jobsec, levels = c(
        "Strongly agree",
        "Agree",
        "Neither nor",
        "Disagree",
        "Strongly disagree"), ordered = TRUE))

ggplot(long_pred_bad, aes(x = eprc, y = prob, color = jobsec)) +
  geom_line(linewidth = 1.5) +
  labs(x = "Employment protection score (eprc)",
    y = "Estimated probability",
    color = "Job Security",
    title = "Estimated Probability of Job Security across EPRC",
    subtitle = "Relationship with Management: Bad") +
  theme_classic() +
  scale_color_manual(values = c(
      "Strongly agree"    = "black",
      "Agree"             = "darkgrey",
      "Neither nor"       = "khaki",
      "Disagree"          = "coral",
      "Strongly disagree" = "red3"))


```

Predictions across levels of eprc for rmgt3 set to Neither nor: 

```{r}
new1 <- data.frame(eprc = 0:6, rmgt3="Neither nor", unemp = median(data_clean$unemp), 
                  ltu = median(data_clean$ltu), 
                  sex2 = mean(sex2),
                  age = median(data_clean$age), 
                  sector2 = mean(sector2), 
                  fulltime2 =  mean(fulltime2),
                  union2 = mean(union2))
predict(mod, type = "response", newdata = new1) %>% matplot(type="b")

predict_neither <- predict(mod, type = "response", newdata = new1)

## nicer graph in ggplot
pred_neither <- cbind(new1, predict_neither)

long_pred_neither <- pred_neither %>%
     pivot_longer(cols = colnames(predict_neither),
    names_to = "jobsec",
    values_to = "prob")%>%
  mutate(jobsec = factor(jobsec, levels = c(
        "Strongly agree",
        "Agree",
        "Neither nor",
        "Disagree",
        "Strongly disagree"), ordered = TRUE))

ggplot(long_pred_neither, aes(x = eprc, y = prob, color = jobsec)) +
  geom_line(linewidth = 1.5) +
  labs(x = "Employment protection score (eprc)",
    y = "Estimated probability",
    color = "Job Security",
    title = "Estimated Probability of Job Security across EPRC",
    subtitle = "Relationship with Management: Neither") +
  theme_classic() +
  scale_color_manual(values = c(
      "Strongly agree"    = "black",
      "Agree"             = "darkgrey",
      "Neither nor"       = "khaki",
      "Disagree"          = "coral",
      "Strongly disagree" = "red3"))

```

Predictions across levels of eprc for rmgt3 set to Good: 

```{r}
new2 <- data.frame(eprc = 0:6, rmgt3="Good", unemp = median(data_clean$unemp), 
                  ltu = median(data_clean$ltu), 
                  sex2 = mean(sex2),
                  age = median(data_clean$age), 
                  sector2 = mean(sector2), 
                  fulltime2 =  mean(fulltime2),
                  union2 = mean(union2))
predict(mod, type = "response", newdata = new2) %>% matplot(type="b")

predict_good <- predict(mod, type = "response", newdata = new2)

## nicer graph in ggplot
pred_good <- cbind(new2, predict_good)

long_pred_good<- pred_good %>%
     pivot_longer(cols = colnames(predict_good),
    names_to = "jobsec",
    values_to = "prob")%>%
  mutate(jobsec = factor(jobsec, levels = c(
        "Strongly agree",
        "Agree",
        "Neither nor",
        "Disagree",
        "Strongly disagree"), ordered = TRUE))

ggplot(long_pred_good, aes(x = eprc, y = prob, color = jobsec)) +
  geom_line(linewidth = 1.5) +
  labs(x = "Employment protection score (eprc)",
    y = "Estimated probability",
    color = "Job Security",
    title = "Estimated Probability of Job Security across EPRC",
    subtitle = "Relationship with Management: Good") +
  theme_classic() +
  scale_color_manual(values = c(
      "Strongly agree"    = "black",
      "Agree"             = "darkgrey",
      "Neither nor"       = "khaki",
      "Disagree"          = "coral",
      "Strongly disagree" = "red3"))

```





